<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 10.2.0" />
<meta name="description" content="Building and configuring a tiny Stratum 1 timeserver" />
<meta name="keywords" content="Raspberry Pi, BeagleBone, NTP, NTPsec, time service" />
<title>Stratum-1-Microserver HOWTO</title>
<style type="text/css">
/* Shared CSS for AsciiDoc xhtml11 and html5 backends */

/* Default font. */
body {
  font-family: Georgia,serif;
}

/* Title font. */
h1, h2, h3, h4, h5, h6,
div.title, caption.title,
thead, p.table.header,
#toctitle,
#author, #revnumber, #revdate, #revremark,
#footer {
  font-family: Arial,Helvetica,sans-serif;
}

body {
  margin: 1em 5% 1em 5%;
}

a {
  color: blue;
  text-decoration: underline;
}
a:visited {
  color: fuchsia;
}

em {
  font-style: italic;
  color: navy;
}

strong {
  font-weight: bold;
  color: #083194;
}

h1, h2, h3, h4, h5, h6 {
  color: #527bbd;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1, h2, h3 {
  border-bottom: 2px solid silver;
}
h2 {
  padding-top: 0.5em;
}
h3 {
  float: left;
}
h3 + * {
  clear: left;
}
h5 {
  font-size: 1.0em;
}

div.sectionbody {
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

ul, ol, li > p {
  margin-top: 0;
}
ul > li     { color: #aaa; }
ul > li > * { color: black; }

.monospaced, code, pre {
  font-family: "Courier New", Courier, monospace;
  font-size: inherit;
  color: navy;
  padding: 0;
  margin: 0;
}
pre {
  white-space: pre-wrap;
}

#author {
  color: #527bbd;
  font-weight: bold;
  font-size: 1.1em;
}
#email {
}
#revnumber, #revdate, #revremark {
}

#footer {
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

#preamble {
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.0em;
  margin-bottom: 2.0em;
  margin-right: 10%;
  color: #606060;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  color: #527bbd;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid #dddddd;
  border-left: 4px solid #f0f0f0;
  padding: 0.5em;
}

div.listingblock > div.content {
  border: 1px solid #dddddd;
  border-left: 5px solid #f0f0f0;
  background: #f8f8f8;
  padding: 0.5em;
}

div.quoteblock, div.verseblock {
  padding-left: 1.0em;
  margin-left: 1.0em;
  margin-right: 10%;
  border-left: 5px solid #f0f0f0;
  color: #888;
}

div.quoteblock > div.attribution {
  padding-top: 0.5em;
  text-align: right;
}

div.verseblock > pre.content {
  font-family: inherit;
  font-size: inherit;
}
div.verseblock > div.attribution {
  padding-top: 0.75em;
  text-align: left;
}
/* DEPRECATED: Pre version 8.2.7 verse style literal block. */
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #527bbd;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 3px solid #dddddd;
}

div.exampleblock > div.content {
  border-left: 3px solid #dddddd;
  padding-left: 0.5em;
}

div.imageblock div.content { padding-left: 0; }
span.image img { border-style: none; vertical-align: text-bottom; }
a.image:visited { color: white; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: normal;
  color: navy;
}
dd > *:first-child {
  margin-top: 0.1em;
}

ul, ol {
    list-style-position: outside;
}
ol.arabic {
  list-style-type: decimal;
}
ol.loweralpha {
  list-style-type: lower-alpha;
}
ol.upperalpha {
  list-style-type: upper-alpha;
}
ol.lowerroman {
  list-style-type: lower-roman;
}
ol.upperroman {
  list-style-type: upper-roman;
}

div.compact ul, div.compact ol,
div.compact p, div.compact p,
div.compact div, div.compact div {
  margin-top: 0.1em;
  margin-bottom: 0.1em;
}

tfoot {
  font-weight: bold;
}
td > div.verse {
  white-space: pre;
}

div.hdlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
div.hdlist tr {
  padding-bottom: 15px;
}
dt.hdlist1.strong, td.hdlist1.strong {
  font-weight: bold;
}
td.hdlist1 {
  vertical-align: top;
  font-style: normal;
  padding-right: 0.8em;
  color: navy;
}
td.hdlist2 {
  vertical-align: top;
}
div.hdlist.compact tr {
  margin: 0;
  padding-bottom: 0;
}

.comment {
  background: yellow;
}

.footnote, .footnoteref {
  font-size: 0.8em;
}

span.footnote, span.footnoteref {
  vertical-align: super;
}

#footnotes {
  margin: 20px 0 20px 0;
  padding: 7px 0 0 0;
}

#footnotes div.footnote {
  margin: 0 0 5px 0;
}

#footnotes hr {
  border: none;
  border-top: 1px solid silver;
  height: 1px;
  text-align: left;
  margin-left: 0;
  width: 20%;
  min-width: 100px;
}

div.colist td {
  padding-right: 0.5em;
  padding-bottom: 0.3em;
  vertical-align: top;
}
div.colist td img {
  margin-top: 0.3em;
}

@media print {
  #footer-badges { display: none; }
}

#toc {
  margin-bottom: 2.5em;
}

#toctitle {
  color: #527bbd;
  font-size: 1.1em;
  font-weight: bold;
  margin-top: 1.0em;
  margin-bottom: 0.1em;
}

div.toclevel0, div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 {
  margin-top: 0;
  margin-bottom: 0;
}
div.toclevel2 {
  margin-left: 2em;
  font-size: 0.9em;
}
div.toclevel3 {
  margin-left: 4em;
  font-size: 0.9em;
}
div.toclevel4 {
  margin-left: 6em;
  font-size: 0.9em;
}

span.aqua { color: aqua; }
span.black { color: black; }
span.blue { color: blue; }
span.fuchsia { color: fuchsia; }
span.gray { color: gray; }
span.green { color: green; }
span.lime { color: lime; }
span.maroon { color: maroon; }
span.navy { color: navy; }
span.olive { color: olive; }
span.purple { color: purple; }
span.red { color: red; }
span.silver { color: silver; }
span.teal { color: teal; }
span.white { color: white; }
span.yellow { color: yellow; }

span.aqua-background { background: aqua; }
span.black-background { background: black; }
span.blue-background { background: blue; }
span.fuchsia-background { background: fuchsia; }
span.gray-background { background: gray; }
span.green-background { background: green; }
span.lime-background { background: lime; }
span.maroon-background { background: maroon; }
span.navy-background { background: navy; }
span.olive-background { background: olive; }
span.purple-background { background: purple; }
span.red-background { background: red; }
span.silver-background { background: silver; }
span.teal-background { background: teal; }
span.white-background { background: white; }
span.yellow-background { background: yellow; }

span.big { font-size: 2em; }
span.small { font-size: 0.6em; }

span.underline { text-decoration: underline; }
span.overline { text-decoration: overline; }
span.line-through { text-decoration: line-through; }

div.unbreakable { page-break-inside: avoid; }


/*
 * xhtml11 specific
 *
 * */

div.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.tableblock > table {
  border: 3px solid #527bbd;
}
thead, p.table.header {
  font-weight: bold;
  color: #527bbd;
}
p.table {
  margin-top: 0;
}
/* Because the table frame attribute is overridden by CSS in most browsers. */
div.tableblock > table[frame="void"] {
  border-style: none;
}
div.tableblock > table[frame="hsides"] {
  border-left-style: none;
  border-right-style: none;
}
div.tableblock > table[frame="vsides"] {
  border-top-style: none;
  border-bottom-style: none;
}


/*
 * html5 specific
 *
 * */

table.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
thead, p.tableblock.header {
  font-weight: bold;
  color: #527bbd;
}
p.tableblock {
  margin-top: 0;
}
table.tableblock {
  border-width: 3px;
  border-spacing: 0px;
  border-style: solid;
  border-color: #527bbd;
  border-collapse: collapse;
}
th.tableblock, td.tableblock {
  border-width: 1px;
  padding: 4px;
  border-style: solid;
  border-color: #527bbd;
}

table.tableblock.frame-topbot {
  border-left-style: hidden;
  border-right-style: hidden;
}
table.tableblock.frame-sides {
  border-top-style: hidden;
  border-bottom-style: hidden;
}
table.tableblock.frame-none {
  border-style: hidden;
}

th.tableblock.halign-left, td.tableblock.halign-left {
  text-align: left;
}
th.tableblock.halign-center, td.tableblock.halign-center {
  text-align: center;
}
th.tableblock.halign-right, td.tableblock.halign-right {
  text-align: right;
}

th.tableblock.valign-top, td.tableblock.valign-top {
  vertical-align: top;
}
th.tableblock.valign-middle, td.tableblock.valign-middle {
  vertical-align: middle;
}
th.tableblock.valign-bottom, td.tableblock.valign-bottom {
  vertical-align: bottom;
}


/*
 * manpage specific
 *
 * */

body.manpage h1 {
  padding-top: 0.5em;
  padding-bottom: 0.5em;
  border-top: 2px solid silver;
  border-bottom: 2px solid silver;
}
body.manpage h2 {
  border-style: none;
}
body.manpage div.sectionbody {
  margin-left: 3em;
}

@media print {
  body.manpage div#toc { display: none; }
}


</style>
<script type="text/javascript">
/*<![CDATA[*/
var asciidoc = {  // Namespace.

/////////////////////////////////////////////////////////////////////
// Table Of Contents generator
/////////////////////////////////////////////////////////////////////

/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, 2006, 2009. License: GPL */

// toclevels = 1..4.
toc: function (toclevels) {

  function getText(el) {
    var text = "";
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
        text += i.data;
      else if (i.firstChild != null)
        text += getText(i);
    }
    return text;
  }

  function TocEntry(el, text, toclevel) {
    this.element = el;
    this.text = text;
    this.toclevel = toclevel;
  }

  function tocEntries(el, toclevels) {
    var result = new Array;
    var re = new RegExp('[hH]([1-'+(toclevels+1)+'])');
    // Function that scans the DOM tree for header elements (the DOM2
    // nodeIterator API would be a better technique but not supported by all
    // browsers).
    var iterate = function (el) {
      for (var i = el.firstChild; i != null; i = i.nextSibling) {
        if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
          var mo = re.exec(i.tagName);
          if (mo && (i.getAttribute("class") || i.getAttribute("className")) != "float") {
            result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
          }
          iterate(i);
        }
      }
    }
    iterate(el);
    return result;
  }

  var toc = document.getElementById("toc");
  if (!toc) {
    return;
  }

  // Delete existing TOC entries in case we're reloading the TOC.
  var tocEntriesToRemove = [];
  var i;
  for (i = 0; i < toc.childNodes.length; i++) {
    var entry = toc.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div'
     && entry.getAttribute("class")
     && entry.getAttribute("class").match(/^toclevel/))
      tocEntriesToRemove.push(entry);
  }
  for (i = 0; i < tocEntriesToRemove.length; i++) {
    toc.removeChild(tocEntriesToRemove[i]);
  }

  // Rebuild TOC entries.
  var entries = tocEntries(document.getElementById("content"), toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "_toc_" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
  if (entries.length == 0)
    toc.parentNode.removeChild(toc);
},


/////////////////////////////////////////////////////////////////////
// Footnotes generator
/////////////////////////////////////////////////////////////////////

/* Based on footnote generation code from:
 * http://www.brandspankingnew.net/archive/2005/07/format_footnote.html
 */

footnotes: function () {
  // Delete existing footnote entries in case we're reloading the footnodes.
  var i;
  var noteholder = document.getElementById("footnotes");
  if (!noteholder) {
    return;
  }
  var entriesToRemove = [];
  for (i = 0; i < noteholder.childNodes.length; i++) {
    var entry = noteholder.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div' && entry.getAttribute("class") == "footnote")
      entriesToRemove.push(entry);
  }
  for (i = 0; i < entriesToRemove.length; i++) {
    noteholder.removeChild(entriesToRemove[i]);
  }

  // Rebuild footnote entries.
  var cont = document.getElementById("content");
  var spans = cont.getElementsByTagName("span");
  var refs = {};
  var n = 0;
  for (i=0; i<spans.length; i++) {
    if (spans[i].className == "footnote") {
      n++;
      var note = spans[i].getAttribute("data-note");
      if (!note) {
        // Use [\s\S] in place of . so multi-line matches work.
        // Because JavaScript has no s (dotall) regex flag.
        note = spans[i].innerHTML.match(/\s*\[([\s\S]*)]\s*/)[1];
        spans[i].innerHTML =
          "[<a id='_footnoteref_" + n + "' href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
        spans[i].setAttribute("data-note", note);
      }
      noteholder.innerHTML +=
        "<div class='footnote' id='_footnote_" + n + "'>" +
        "<a href='#_footnoteref_" + n + "' title='Return to text'>" +
        n + "</a>. " + note + "</div>";
      var id =spans[i].getAttribute("id");
      if (id != null) refs["#"+id] = n;
    }
  }
  if (n == 0)
    noteholder.parentNode.removeChild(noteholder);
  else {
    // Process footnoterefs.
    for (i=0; i<spans.length; i++) {
      if (spans[i].className == "footnoteref") {
        var href = spans[i].getElementsByTagName("a")[0].getAttribute("href");
        href = href.match(/#.*/)[0];  // Because IE return full URL.
        n = refs[href];
        spans[i].innerHTML =
          "[<a href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
      }
    }
  }
},

install: function(toclevels) {
  var timerId;

  function reinstall() {
    asciidoc.footnotes();
    if (toclevels) {
      asciidoc.toc(toclevels);
    }
  }

  function reinstallAndRemoveTimer() {
    clearInterval(timerId);
    reinstall();
  }

  timerId = setInterval(reinstall, 500);
  if (document.addEventListener)
    document.addEventListener("DOMContentLoaded", reinstallAndRemoveTimer, false);
  else
    window.onload = reinstallAndRemoveTimer;
}

}
asciidoc.install(2);
/*]]>*/
</script>
</head>
<body class="article">
<div id="header">
<h1>Stratum-1-Microserver HOWTO</h1>
<span id="author">by Eric S. Raymond</span><br />
<div id="toc">
  <div id="toctitle">Table of Contents</div>
  <noscript><p><b>JavaScript must be enabled in your browser to display the table of contents.</b></p></noscript>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_introduction">Introduction</h2>
<div class="sectionbody">
<div class="paragraph"><p>This HOWTO gives complete instructions for building a headless Stratum
1 timeserver using a Raspberry Pi or workalike SBC (= Single Board
Computer), a GPS HAT (= daughterboard designed for the Pi and
workalikes), and NTPsec <a href="#NTPSEC">[NTPSEC]</a>.  Total parts cost should be about
$110.  Beginner-level light soldering may be required.</p></div>
<div class="paragraph"><p>Why do it?  It&#8217;s cheap, fun, and because your NTP server is running on
a dedicated machine you won&#8217;t have so much jitter due to variable
load.</p></div>
<div class="paragraph"><p>A GPS daughterboard (what Pi folks call a HAT after the Pi&#8217;s interface
specification, Hardware Attached on Top) is a better idea than an
external GPS because a HAT uses an internal RS-232 interface that cuts
latency and jitter compared to a USB GPS, and provides the 1PPS signal
required for precision time service.  Generic USB GPSes do not deliver
this signal and therefore cannot be used for Stratum 1 service
<span class="footnote"><br />[There is one line of USB GPSes, the Navisys
GR601-W/GR701-W/GR801-W, that provides 1PPS.]<br /></span>.</p></div>
<div class="paragraph"><p>Most of this build is actually independent of any one daughterboard&#8217;s
hardware idiosyncrasies.  The build may also generalize to other
HAT-compatible Unix SBCs such as the BeagleBone, though details of
those remain to be filled in.  To emphasize which parts of the build
won&#8217;t vary versus those that will, we will refer to the main board as
"SBC" for the invariant parts and as "Pi", "Pi 2", or "Pi 3"
for the board-specific parts.</p></div>
<div class="paragraph"><p>Where this HOWTO says "I" it refers to the author&#8217;s direct experience;
"we" includes both the author and various technical experts who
assisted in the preparation of this document.</p></div>
<div class="paragraph"><p>This tutorial assumes some basic Unix competence.  You will not need
to be a programmer or an expert system administrator; you will need to
know your way around the command line a little and how to edit
files. <span class="footnote"><br />[If you are a beginner, you might want to use the
<em>nano</em> editor, e.g. "nano /boot/config.txt".]<br /></span></p></div>
<div class="paragraph"><p>Final note: if you&#8217;re looking for instructions on setting up time
service with a conventional PC and cable-attached GPS, see <a href="#GPSD-SERVICE">[GPSD-SERVICE]</a>.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_parts_list_and_hardware_assembly">Parts list and hardware assembly</h2>
<div class="sectionbody">
<div class="paragraph"><p>You will need:</p></div>
<div class="ulist"><ul>
<li>
<p>
One Raspberry Pi or workalike SBC.  I used a
  Raspberry Pi 3: these instructions cover older variants as well.
</p>
</li>
<li>
<p>
One compatible GPS HAT.  Possibilities are:
</p>
<div class="tableblock">
<table rules="all"
width="50%"
frame="hsides"
cellspacing="0" cellpadding="4">
<col width="33%" />
<col width="33%" />
<col width="33%" />
<thead>
<tr>
<th align="left" valign="top"> HAT type                                 </th>
<th align="left" valign="top"> Battery </th>
<th align="left" valign="top"> Build status</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><a href="https://learn.adafruit.com/adafruit-ultimate-gps-hat-for-raspberry-pi">Adafruit GPS HAT</a></p></td>
<td align="left" valign="top"><p class="table">CR1220</p></td>
<td align="left" valign="top"><p class="table">Tested</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><a href="https://store.uputronics.com/index.php?route=product/product&amp;path=60_64&amp;product_id=81">Uputronics GPS Expansion Board</a></p></td>
<td align="left" valign="top"><p class="table">CR2032</p></td>
<td align="left" valign="top"><p class="table">Tested</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p>+
Of these, I prefer the Uputronics board.  The combination of a
u-blox 8 and solderless assembly is tough to beat.</p></div>
</li>
<li>
<p>
One 3.3-volt lithium button cell.  The CR1220 is cheapest
  ordered from Adafruit along with the HAT, but note that this may slow
  delivery, as button cells prevent shipment by air. Alternatively you can
  buy compatible button cells at most places that carry hearing-aid batteries.
</p>
</li>
<li>
<p>
A micro-SD reader/writer for making bootable OS images.
</p>
</li>
<li>
<p>
A micro-SD card. 4GB will suffice, but note that the current "sweet spot"
  in pricing is actually 16GB. A high-quality name-brand micro-SD card, such
  as a SanDisk Ultra, can be had for less than $10. Avoid unknown brands;
  performance and longevity are likely to be poor.
</p>
</li>
<li>
<p>
A Linux host machine and an Ethernet cable on which your Pi can
  see your local network and the Internet.
</p>
</li>
<li>
<p>
Either a 5V, 2.5A power supply with a micro-USB outlet (same as the
  standard charger for smartphones) or a USB-to-Micro-USB cable that
  can take power from the host machine.
</p>
</li>
<li>
<p>
A USB keyboard and HDMI-capable display.  You&#8217;ll do most of
  the software installation and configuration via ssh from your host
  machine, but you need to be off-net for the next step.
</p>
</li>
<li>
<p>
(Optional) A case to protect your hardware from dust and curious
  felines.
</p>
</li>
<li>
<p>
(Optional) 2 hex standoffs, 11mm with M2.5 threading, compatible
  screws.  Adafruit sells these <a href="#STANDOFFS">[STANDOFFS]</a>.  They are very
  similar to the standard spacers used in PC cases; if you keep the small
  parts from old PCs around you&#8217;ll have a dozen of them and probably
  the screws to match.
</p>
</li>
</ul></div>
<div class="paragraph"><p>The Adafruit and Uputronics HATs are shipped as two parts each, a circuit
board and a 40-pin header. The header on the Uputronics board snugs into an
on-board fitting and does not require soldering.</p></div>
<div class="paragraph"><p>Note that if you&#8217;re going to use a CR2032 with the Uputronics HAT, a
jumper on the board needs to be desoldered.  It lives in a white box
outline near the + pole of the battery cradle.  As shipped, it is
covered by a small dome of solder.  The latest versions of the Uputronics HAT
uses a supercapacitor (or two) instead of a battery, so no soldering is
required.</p></div>
<div class="paragraph"><p>The header on the assembled HAT will fit down over the double row of pins
on one edge of the SBC, such that when fully assembled the SBC and HAT will
make a neat stack with all four pairs of corner holes vertically aligned.</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Find "north" on the HAT.  It&#8217;s the edge that the GPS module is
closest to, and has a rectangular notch in it (a cutout for a ribbon
cable).  The GPIO header will be 90 degrees clockwise.  If this isn&#8217;t
clear enough, see <a href="bluewire.jpg">this photograph</a>.
</p>
</li>
<li>
<p>
If you have them, screw the the two hex standoffs to the corner
holes on the west side of the SBC, female end up.  These will
support the HAT.
</p>
</li>
<li>
<p>
Mate the female side of the detached 40-pin header with the
40-pin GPIO connector on the east edge of the SBC.  If your HAT
is pre-soldered, your boards are now stacked and you skip the next step.
</p>
</li>
<li>
<p>
Lay the HAT over the board in such a way that the two sets of 4
corner holes line up and the header pins poke through a matching 40
holes in the HAT.  The GPS module and battery clip should face
upwards.  If you added standoffs, they should match the corner holes of
the HAT.  Solder each header pin into its through-hole.  This is the last
bit of hardware hacking absolutely required.
</p>
</li>
<li>
<p>
If you added standoffs, now secure the HAT to their
female-threaded upper ends using the screws.  This will help
protect the headers and pins from mechanical stress if the
assembly is dropped or has something sat on it.
</p>
</li>
<li>
<p>
Optional: fit the SBC into a case bottom before plugging in the HAT.
Anything sold as a "Raspberry Pi" case ought to do for the Adafruit
HAT, because a single HAT doesn&#8217;t project above the USB &amp; Ethernet
connectors on the SBC.  The Raspberry Pi Foundation Case qualifies, but
for functional reasons we recommend a transparent case.  The Adafruit
2258 case <a href="#2258">[2258]</a>, for example, should do nicely.  The Uputronics HAT, alas,
has a projecting SMA antenna jacks that won&#8217;t fit in a stock case.  A bit of
work with a Dremel tool will fix that. Alternatively, if you use the Uputronics
HAT, both Uputronics and ModMyPi sell a case <a href="#MODMYPI-CASE">[MODMYPI-CASE]</a> specifically
designed for it.
</p>
</li>
</ol></div>
</div>
</div>
<div class="sect1">
<h2 id="_understanding_the_gpio_connector">Understanding the GPIO connector</h2>
<div class="sectionbody">
<div class="paragraph"><p>The pins you&#8217;ll plug the HAT into are the SBC&#8217;s primary GPIO
(General Purpose I/O) header.</p></div>
<div class="paragraph"><p>The Pi 3 and other recent Pi variants have 40 pins in the
GPIO header.  Older variants, the original Pi A and B, have only 26
pins.  The assignments for those pins on later versions are
backward-compatible.</p></div>
<div class="paragraph"><p>The GPIO pins are sometimes referenced by physical pin location on the
header (1-26 or 1-40), and sometimes as the GPIO line connected to the
CPU.  This can cause confusion, especially since some kit-builders use
variant GPIO numberings.  All GPIO numbers in this HOWTO reference
<a href="#PI-PINOUT">[PI-PINOUT]</a>.</p></div>
<div class="paragraph"><p>Physical pins are best referred to as P-[1-40] or as
GPIO[0-31].  Some are typically pre-configured for specific functions
(serial, i2c, etc.)  Two that will be important for this build are the
TX and RX serial lines attached to the SBC&#8217;s UART.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_configuration_overview">Configuration overview</h2>
<div class="sectionbody">
<div class="paragraph"><p>The steps in this configuration sequence have been carefully ordered
to commit you to as few changes that are difficult to reverse as
possible before you are certain you can make the hardware work as
a dedicated timeserver.</p></div>
<div class="paragraph"><p>The work divides into the following phases:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Early configuration
</p>
</li>
<li>
<p>
Smoke-test the SBC/HAT combination
</p>
</li>
<li>
<p>
Live-test the GPS
</p>
</li>
<li>
<p>
Build and configure NTPsec
</p>
</li>
<li>
<p>
Installation and boot-time setup
</p>
</li>
<li>
<p>
Secure the machine.
</p>
</li>
<li>
<p>
Performance tuning
</p>
</li>
<li>
<p>
Simplification and optimization
</p>
</li>
</ol></div>
<div class="paragraph"><p>Within each phase, we try to indicate how difficult each operation is
to back out.</p></div>
<div class="paragraph"><p>This recipe consists of a few commands run on your host machine, and
more on your SBC.  A <em>#</em> before a command line means you need to be
root to run it.  Some commands won&#8217;t require root; those command lines
will be marked with "$".  Remember that you go root with the command
"sudo -s" or (after you have set a root password) "su -".</p></div>
<div class="sect2">
<h3 id="_making_a_bootable_sd">Making a bootable SD</h3>
<div class="paragraph"><p>Download the latest Raspbian Stretch Lite from <a href="#RASPBIAN">[RASPBIAN]</a> to your host.</p></div>
<div class="paragraph"><p>Use sha256sum to verify the correctness of the image. Remember to substitute
the name of the current image zip file. For example:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ sha256sum 2018-06-27-raspbian-stretch-lite.zip
3271b244734286d99aeba8fa043b6634cad488d211583814a2018fc14fdca313 2018-06-27-raspbian-stretch-lite.zip</code></pre>
</div></div>
<div class="paragraph"><p>The hex string this command returns should match the checksum on
the Raspbian download page.  If it doesn&#8217;t, you have a corrupted image
and should re-fetch it.</p></div>
<div class="paragraph"><p>Note that this is not the regular NOOBS image, but a <em>light</em> one specifically
designed to boot the Pi as a headless server, communicated with only
by Ethernet.  By going this route we get to avoid some hardware
prerequisites that would never be used after install, and skip a bunch
of steps in removing unnecessary desktop software.</p></div>
<div class="paragraph"><p>sudo to root and install dcfldd on your host machine:</p></div>
<div class="listingblock">
<div class="content">
<pre><code># apt install dcfldd</code></pre>
</div></div>
<div class="paragraph"><p>Insert an SD card into the reader and, if it&#8217;s a USB reader, plug the
other end into a USB port on your host.</p></div>
<div class="paragraph"><p>Note: your host may automount the card if it has been set up for Linux
before - whether this happens depends on what distribution and desktop
environment you are using.  If your window manager pops up a
file-browser view of the device, you should unmount it through that
GUI.</p></div>
<div class="paragraph"><p>You can use the older <em>dd</em> if you do the next step manually, but
dfcldd is better about giving you progress messages during the
operation.</p></div>
<div class="paragraph"><p>Better yet, we provide a script, <a href="ddimage">ddimage</a>, to
semi-automate the next step of the process; it&#8217;s safer to use that,
because it performs some sanity checks that should prevent you from
scribbling on your disks. ddimage instructions are further below.</p></div>
<div class="paragraph"><p>Either way, automatic or manual, you&#8217;ll need to know the device name
of your SD card reader.  On a host running Debian or Ubuntu, the USB
device will most likely be /dev/sdd, but could have a different last letter
depending on how many hard drives you have and how your reader firmware
is set up.  If you&#8217;re using a built-in SD reader port, e.g. on a laptop, the
devicename might be something like <em>/dev/mmcblk0</em></p></div>
<div class="paragraph"><p>First, unpack the zip file to get an img file (remember to substitute the
name of the current image zip file):</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ unzip 2018-06-27-raspbian-stretch-lite.zip</code></pre>
</div></div>
<div class="paragraph"><p>To proceed manually, follow the directions at <a href="#INSTALLATION">[INSTALLATION]</a>, using dfcldd.
Your command will look something like this - again, using the current image
name:</p></div>
<div class="listingblock">
<div class="content">
<pre><code># dcfldd statusinterval=16 sizeprobe=if bs=4M if=2018-06-27-raspbian-stretch-lite.img of=/dev/sdd</code></pre>
</div></div>
<div class="paragraph"><p>For safety&#8217;s sake, force pending I/O to the SD card before removing it.</p></div>
<div class="listingblock">
<div class="content">
<pre><code># sync</code></pre>
</div></div>
<div class="paragraph"><p>To use ddimage, first download it:</p></div>
<div class="listingblock">
<div class="content">
<pre><code># wget http://www.ntpsec.org/white-papers/stratum-1-microserver-howto/ddimage</code></pre>
</div></div>
<div class="paragraph"><p>Now read it. You should always read any script that will
run with root permissions, to check that it doesn&#8217;t do anything
nefarious.  Give it the basename of your SD reader (usually "sdd"). It
will do some safety checks, then generate a dcfldd command
like the above.</p></div>
<div class="paragraph"><p>You should make it executable so you can run it as a script:</p></div>
<div class="listingblock">
<div class="content">
<pre><code># chmod a+x ddimage</code></pre>
</div></div>
<div class="paragraph"><p>Your ddimage command execution should look roughly like this:</p></div>
<div class="listingblock">
<div class="content">
<pre><code># ./ddimage sdd
Checking /dev/sdd
/dev/sdd exists as a storage device.
/dev/sdd is not mounted
Copying 2018-06-27-raspbian-stretch-lite.img...
[97% of 1768Mb] 432 blocks (1728Mb) written. 00:00:00 remaining.
442+1 records in
442+1 records out
Done</code></pre>
</div></div>
<div class="paragraph"><p>with an animated progress line in the middle.</p></div>
<div class="paragraph"><p>Note: this can take a while, with lag between the "records out" line
and the "Done".  Many USB SD readers have an activity light that
blinks while accesses are going on; if yours does, watch for it to
stop blinking.</p></div>
</div>
<div class="sect2">
<h3 id="_first_boot">First boot</h3>
<div class="paragraph"><p>Take the card out of the SD reader and insert it into your SBC.
Ethernet should <strong>not</strong> be plugged in!  Attach the keyboard and
display.  Power up.</p></div>
<div class="paragraph"><p>Log in as the default user, with the default password.  (On the
Raspberry Pi this is <em>pi</em> and <em>raspberry</em>.)</p></div>
<div class="paragraph"><p>Now run "sudo raspi-config".  Choose "Interfacing options"-&gt;"SSH" and
enable it. Without this step (not required on previous Raspbian
releases) you will not be able to ssh into the device.</p></div>
<div class="paragraph"><p>Use <em>passwd</em> to change the password of the default user.  Don&#8217;t use
anything obvious or cute.  Remember the password until, later in this
process, the default user account is removed.</p></div>
<div class="paragraph"><p>The reason this step had to be done off-net is because there are
attack bots on the public Internet dedicated to using the combination of a
known login and known password to try to subvert machines before
they can be secured.  To see those hunting for Raspberry Pis, for
example, do this on any Internet-facing machine:</p></div>
<div class="listingblock">
<div class="content">
<pre><code># lastb | grep -w pi</code></pre>
</div></div>
<div class="paragraph"><p>You can&#8217;t use anything obvious or cute as a password because those
bots could very well run a specialized dictionary attack if they find
a passworded SBC with one of the names they&#8217;re expecting.</p></div>
<div class="paragraph"><p>You can skip the re-passwording step only if your network lives behind
a firewall with both IPv4 and IPv6 forwarding rules.  If anyone on the
public Internet can reach your SBC via ssh before you either change
the default-account password or remove the default account altogether,
your Pi could be enslaved by an attack bot within minutes.</p></div>
</div>
<div class="sect2">
<h3 id="_first_ssh_access">First ssh access</h3>
<div class="paragraph"><p>Next, make sure your SBC has a live Ethernet cable plugged in and
connected to the same network as your host (because it will also need
to see the general Internet, direct-connecting to your PC is
insufficient). Power it up and wait about 60 seconds (or, if you can
see the Ethernet-port LEDs, wait for them to start flashing) then use
the default machine name and login to ssh from your host.  For a
Raspberry Pi, that looks like this:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ ssh pi@raspberrypi.local</code></pre>
</div></div>
<div class="paragraph"><p>You may see some warnings from ssh about an unknown host; tell it yes,
you want to connect.  Then you should be asked for a login password.</p></div>
<div class="paragraph"><p>If ssh tells you it can&#8217;t see any host with the expected name,
either the SBC hasn&#8217;t yet booted or your network can&#8217;t see it.  Don&#8217;t
panic.  Check for a green light on the Pi&#8217;s Ethernet port to be sure
it&#8217;s plugged in properly.  Make sure your SD card is electrode-side-up
(unplugging the power before removing it, if you have to) and
properly seated.  Wait 30 seconds and try again.</p></div>
<div class="paragraph"><p>Another possibility is that your host doesn&#8217;t have a zeroconf
implementation like Linux&#8217;s <em>avahi-daemon</em> installed.  Try to fix
that.  This may work:</p></div>
<div class="listingblock">
<div class="content">
<pre><code># apt install libnss-mdns</code></pre>
</div></div>
<div class="paragraph"><p>If that doesn&#8217;t work, check the display connected to the SBC and
figure out the assigned address with the "ip a" command.  If the output
of "ip a" doesn&#8217;t list "eth0", something else is wrong, which is outside
the scope of this HOWTO; please investigate the many resources on the
Internet that are available.  If "ip a" lists "eth0", ensure that the
word "UP" is listed in the bracketed text immediately to the right of
"eth0", and that the "inet" line lists a dotted-quad IP address.  If
either or both are missing, this is also outside the scope of this
HOWTO. Try rebooting the Pi; it can&#8217;t hurt.</p></div>
<div class="paragraph"><p>Persistent failure after you&#8217;ve tried these things mean you need
to rebuild the SD card image.  Try with a different SD card, as sometimes
older ones go flaky.</p></div>
<div class="paragraph"><p>The hardest part is done; you may remove the keyboard and display now
- you won&#8217;t need them any more!</p></div>
</div>
<div class="sect2">
<h3 id="_clockmaker">Clockmaker</h3>
<div class="paragraph"><p>Most of the remaining instructions do not have to be done by hand.  You can
download <a href="clockmaker">clockmaker</a>, a Python script which
does much of this recipe for you.  Here&#8217;s how to use it:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
As the pi user, copy clockmaker to your home directory with
   this command:
</p>
<div class="listingblock">
<div class="content">
<pre><code>wget http://www.ntpsec.org/white-papers/stratum-1-microserver-howto/clockmaker</code></pre>
</div></div>
</li>
<li>
<p>
Read it.  You should always read any script that will run with root
   permissions, to check that it doesn&#8217;t do anything nefarious.
</p>
</li>
<li>
<p>
Make clockmaker executable with "chmod a+x clockmaker".
</p>
</li>
<li>
<p>
Run "sudo clockmaker --config".  This will do most of the
   tricky OS and hardware configuration; also system software
   updates and prerequisites for the timeserver software.
</p>
</li>
<li>
<p>
Now as the pi user, run "clockmaker --build".  This will clone
   and build the special timeserver software.  It also copies in the current
   versions of the <em>pinup</em> script, and several configuration files
   used in the installation phase.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Some further uses of clockmaker are discussed in later steps.</p></div>
<div class="paragraph"><p>The clockmaker script is intelligent about not redoing steps it has
already done; it is safe to run each stage multiple times.  Redoing
the --build step re-pulls from the software repositories.</p></div>
<div class="paragraph"><p>In the recipe that follows, steps marked "{--config}" or "{--build}"
are parts clockmaker will do for you if you run it.  It is
recommended that you read the steps to understand the process, then
use clockmaker to avoid most of the typing.</p></div>
<div class="paragraph"><p>At this point the steps you can automate with clockmaker begin.  If
you have not downloaded clockmaker, refer to "Using Clockmaker" above.</p></div>
</div>
<div class="sect2">
<h3 id="_fully_update_your_os">Fully update your OS</h3>
<div class="paragraph"><p>{--config} Fully update the Linux on your SBC.  The easiest way to do this is
with these commands:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ sudo -s
# apt update
# apt dist-upgrade</code></pre>
</div></div>
<div class="paragraph"><p>These changes are not reversible, but you&#8217;d want them for any other
use of the SBC anyway.  You always want to be updated with security
patches and other fixes.</p></div>
</div>
<div class="sect2">
<h3 id="_enable_the_uart">Enable the UART</h3>
<div class="paragraph"><p>{--config} Edit the file /boot/cmdline.txt, and remove the following from
the single line in the file:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>console=serial0,115200</code></pre>
</div></div>
<div class="paragraph"><p>This prevents it from spawning a login shell on the serial port that your GPS
needs to use. Ensure that the text remain a single line.</p></div>
<div class="paragraph"><p>{--config} Edit the file /boot/config.txt, and add this line to the end
of the file:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>enable_uart=1</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_pi_3_only_disable_bluetooth_and_remap_console_device">Pi 3 only: disable Bluetooth and remap console device</h3>
<div class="paragraph"><p>The Raspberry Pi Foundation made a design decision on the Raspberry
Pi 3 that ties the serial baud rate to the CPU clock rate (by
default).  This was done because the normal lines that fed the serial
port were used for the built-in Bluetooth.  This does not affect any
other Pi variant.</p></div>
<div class="paragraph"><p>Your timeserver is not going to need Bluetooth, so you should
disable it and remap the devices.  Our instructions come from
<a href="#DOREY">[DOREY]</a>, which explains the problem in more detail.  We don&#8217;t use
some of his steps because this build is designed to run headless.</p></div>
<div class="paragraph"><p>{--config} Edit the file /boot/config.txt again, and add these lines
to the end of the file:</p></div>
<div class="listingblock">
<div class="content">
<pre><code># Disable Bluetooth so serial-tty speed is no longer tied to CPU speed
dtoverlay=pi3-disable-bt</code></pre>
</div></div>
<div class="paragraph"><p>This change restores the behavior to that of the Pi2 and earlier, in which the
serial device attached to the UART is /dev/ttyAMA0 rather than /dev/ttyS0.</p></div>
<div class="paragraph"><p>This change can effectively be reversed by commenting out the
dtoverlay line.</p></div>
<div class="paragraph"><p>{--config} To disable the Bluetooth daemon, since we&#8217;ve disabled the driver,
enter this:</p></div>
<div class="listingblock">
<div class="content">
<pre><code># systemctl disable hciuart</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_other_root_mode_configuration">Other root-mode configuration</h3>
<div class="paragraph"><p>{--config} Create a symlink to the GPS device to make it easier to refer
to.  Put the following in a new file /etc/udev/rules.d/10-pps.rules to
accomplish this.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>KERNEL=="ttyAMA0", SYMLINK+="gpsd0"</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_configure_the_1pps_gpio_pin">Configure the 1PPS GPIO pin</h3>
<div class="paragraph"><p>You&#8217;ll need NTPsec to be able to see the high-precision PPS
(pulse-per-second) signal from the GPS.  But the serial interface from
a HAT only supplies TX/RX; the PPS signal is shipped on a different
pin of the GPIO connector.</p></div>
<div class="paragraph"><p>The RX/TX signals are always expected on the same two pins of the GPIO
(P8 and P10) which connect to the SBC&#8217;s UART.  You can see them,
labeled, near the north end of the connector.  Most other GPIO pins can
be interpreted by the Pi in different ways, configured by software.
Which pin is used for 1PPS is a variable of the HAT design.  Here is a
table:</p></div>
<div class="tableblock">
<table rules="all"
width="25%"
frame="hsides"
cellspacing="0" cellpadding="4">
<col width="25%" />
<col width="25%" />
<col width="25%" />
<col width="25%" />
<thead>
<tr>
<th align="left" valign="top"> HAT        </th>
<th align="left" valign="top"> Physical pin </th>
<th align="left" valign="top"> RPi Logical pin   </th>
<th align="left" valign="top"> Odroid C2 export pin</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p class="table">Adafruit</p></td>
<td align="left" valign="top"><p class="table">P-7</p></td>
<td align="left" valign="top"><p class="table">GPIO04</p></td>
<td align="left" valign="top"><p class="table">249</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Uputronics</p></td>
<td align="left" valign="top"><p class="table">P-12</p></td>
<td align="left" valign="top"><p class="table">GPIO18</p></td>
<td align="left" valign="top"><p class="table">238</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p>A handy resource with a display of the pin locations and ID&#8217;s for the Adafruit
and Uputronics HATs can be found here:
<a href="https://pinout.xyz/boards#type=GPS">pinout.xyz</a></p></div>
<div class="paragraph"><p>There is a Linux kernel driver called pps-gpio which,
given one of these pins, uses the signal from it to support an
RFC2783 interface to PPS that NTPsec (and GPSD) can use.  To
see 1PPS, you need to ensure that this driver is loaded
and monitoring the correct logical pin.</p></div>
<div class="paragraph"><p>The procedure for declaring the GPIO pin varies by Raspbian version.
We only give the formula for the current Raspbian here; you can
find details about older versions at <a href="#TAYLOR">[TAYLOR]</a>;</p></div>
<div class="paragraph"><p>{--config} Edit /boot/config.txt and add these lines to the end of the file,
replacing <em>4</em> with the logical pin number for your HAT if it&#8217;s not an
Adafruit:</p></div>
<div class="listingblock">
<div class="content">
<pre><code># Get 1PPS from HAT pin
dtoverlay=pps-gpio,gpiopin=4</code></pre>
</div></div>
<div class="paragraph"><p>The clockmaker script will do this for you, but not before
installing some packages needed for the next step.</p></div>
<div class="paragraph"><p>A small optimization can be added to the /boot/config.txt file that will
make more memory available to your Pi, since you are running headless. Add
the following to the end of the file:</p></div>
<div class="listingblock">
<div class="content">
<pre><code># Reduce GPU memory split
gpu_mem=16</code></pre>
</div></div>
<div class="paragraph"><p>Once you have fully configured, the last few lines of your
/boot/config.txt file should look rather like this:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>enable_uart=1
# Disable Bluetooth so serial-tty speed is no longer tied to CPU speed
dtoverlay=pi3-disable-bt
# Get 1PPS from HAT pin
dtoverlay=pps-gpio,gpiopin=4
# Reduce GPU memory split
gpu_mem=16</code></pre>
</div></div>
<div class="paragraph"><p>The number after "gpiopin=" may be different.  The order of the lines is
not important.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_optimize_system_performance">Optimize system performance</h2>
<div class="sectionbody">
<div class="paragraph"><p>An optimization that is convenient to apply at this point is telling
the kernel not to run tickless (see <a href="#TICKLESS">[TICKLESS]</a> for technical details).
This can seriously reduce the jitter and offset in a GPS PPS time
server.</p></div>
<div class="paragraph"><p>{--config} Add this to the end of the kernel command-line in
/boot/cmdline.txt, again being careful not to wrap the single line:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>nohz=off</code></pre>
</div></div>
<div class="paragraph"><p>Configuring the system to run at full performance uses more power, but
results in more consistent timing.</p></div>
<div class="listingblock">
<div class="content">
<pre><code># apt -y install cpufrequtils
# echo 'GOVERNOR="performance"' &gt; /etc/default/cpufrequtils
# systemctl restart cpufrequtils</code></pre>
</div></div>
<div class="paragraph"><p>You can verify with the following command, which should print
"performance" once for each CPU:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ cat /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor</code></pre>
</div></div>
<div class="paragraph"><p>If you want to run the system constantly at the lowest frequency
instead (maybe to avoid thermal problems) you can use the governor
"powersave".  Everything will run slower than with governor
"performance", but consistently so and the system may stay cooler.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_disable_the_console">Disable the console</h2>
<div class="sectionbody">
<div class="paragraph"><p>{--config} We need to disable the serial/USB console, so
that later we can remove the default <em>pi</em> user.  It would be better to
change the startup sequence so the login process for the console
is owned by some other privileged user than <em>pi</em>.</p></div>
<div class="listingblock">
<div class="content">
<pre><code># systemctl disable autologin@.service ; systemctl disable getty@tty1.service</code></pre>
</div></div>
<div class="paragraph"><p>You must reboot your SBC at this point for the changes above to take effect.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_smoke_test_the_gps_hat_combination">Smoke-test the GPS/HAT combination</h2>
<div class="sectionbody">
<div class="paragraph"><p>To test that you can read data from the device, do this as root:</p></div>
<div class="listingblock">
<div class="content">
<pre><code># stty -F /dev/gpsd0 raw 9600 cs8 clocal -cstopb
# cat /dev/gpsd0</code></pre>
</div></div>
<div class="paragraph"><p>You should see NMEA0183 sentences issuing in bursts once per second -
text lines usually beginning with "$GP", and possibly a "$PMTK"
sentence.  These will issue whether or not the GPS has satellite lock.</p></div>
<div class="paragraph"><p>This is what the output should resemble:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$GPRMC,205251.00,A,4002.10161,N,07531.20383,W,0.100,,240516,,,A*6D
$GPVTG,,T,,M,0.100,N,0.186,K,A*2D
$GPGGA,205251.00,4002.10161,N,07531.20383,W,1,07,1.16,177.1,M,-34.4,M,,*6B
$GPGSA,A,3,11,13,17,08,07,28,01,,,,,,2.02,1.16,1.66*05
$GPGSV,3,1,11,01,64,097,37,03,07,136,,07,37,183,25,08,21,061,30*73
$GPGSV,3,2,11,11,58,063,39,13,11,288,21,17,37,260,12,19,09,249,25*75
$GPGSV,3,3,11,22,14,111,19,28,57,320,34,30,58,217,*41
$GPGLL,4002.10161,N,07531.20383,W,205251.00,A,A*71
$GPRMC,205252.00,A,4002.10169,N,07531.20380,W,0.092,,240516,,,A*6F
$GPVTG,,T,,M,0.092,N,0.171,K,A*2F</code></pre>
</div></div>
<div class="paragraph"><p>It is not unusual for there to be an initial burst of baud barf before
the first legible sentence, so wait a few seconds.</p></div>
<div class="paragraph"><p>If you see no output or continuing random baud barf, re-do the stty
command being very careful that all the arguments are correct.  If you
still don&#8217;t see output, check that the HAT is correctly seated on the
GPIO and powered up (a red light near the north edge should blink at
least once per 10 seconds).</p></div>
<div class="paragraph"><p>If you don&#8217;t see a light on the HAT, it might not be properly seated
on the GPIO connector. Try powering off, popping the HAT off, and
reseating it.</p></div>
<div class="paragraph"><p>Sometimes changing the baud rate may <em>kickstart</em> communication with the
device if it is balking. You can try this, for example:</p></div>
<div class="listingblock">
<div class="content">
<pre><code># stty -F /dev/gpsd0 raw 38400 cs8 clocal -cstopb
# cat /dev/gpsd0</code></pre>
</div></div>
<div class="paragraph"><p>Other rates may work as well - the adafruit HAT will happily communicate
at 115200. If you decide to stay with a speed other than 9600, you will
need to adjust the "fixed-port-speed=" scons value when building gpsd below,
as well as the "stty" declaration in /etc/init.d/timeservice, also detailed
below.</p></div>
<div class="paragraph"><p>If you still don&#8217;t see legible output after checking these, you may
have a problem this HOWTO can&#8217;t solve - possibly dead or defective
hardware.  However, it is far more likely that you have skipped
a previous step or gotten one slightly wrong.  Recheck your work.</p></div>
<div class="paragraph"><p>This was not a full functional test of the GPS; we&#8217;ll do that later.
It&#8217;s what engineers call a "smoke test", just checking that the
device is alive and doing something reasonably sane.</p></div>
<div class="sect2">
<h3 id="_1pps_output">1PPS output</h3>
<div class="paragraph"><p>To test 1PPS, use ppstest from the pps-tools package.</p></div>
<div class="paragraph"><p>If you are doing these steps by hand rather than with clockmaker,
prepare with this step {--config}:</p></div>
<div class="listingblock">
<div class="content">
<pre><code># apt install pps-tools</code></pre>
</div></div>
<div class="paragraph"><p>Then run this test:</p></div>
<div class="listingblock">
<div class="content">
<pre><code># ppstest /dev/pps0</code></pre>
</div></div>
<div class="paragraph"><p>You should see repeated lines somewhat resembling this, one per second,
until you interrupt:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>source 0 - assert 1461161753.267392352, sequence: 246 - clear  0.000000000, sequence: 0</code></pre>
</div></div>
<div class="paragraph"><p>Note, this will produce a false negative for PPS if the GPS has no fix yet -
if you have not had your SBC powered-up for very long, that is not unusual.
Don&#8217;t worry overly if you do not have PPS output yet.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_live_test_the_gps">Live-test the GPS</h2>
<div class="sectionbody">
<div class="paragraph"><p>Now build GPSD.  If you are using clockmaker, "./clockmaker --build"
will automate the build steps (but not the test procedures).</p></div>
<div class="paragraph"><p>It&#8217;s best to clone the GPSD repository and build from that rather than
installing the Raspbian package.  This both guarantees you the latest
fixes and avoids installing a start-on-boot script that you don&#8217;t want
in this build.</p></div>
<div class="paragraph"><p>Install the following GPSD build prerequisites as follows {--config}:</p></div>
<div class="listingblock">
<div class="content">
<pre><code># apt install git scons libncurses-dev python-dev bc</code></pre>
</div></div>
<div class="paragraph"><p>Don&#8217;t be alarmed if apt advises that additional packages will be installed -
these are prerequisites of the prerequisites!</p></div>
<div class="paragraph"><p>Then do this (as user pi) {--build}:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ git clone https://gitlab.com/gpsd/gpsd.git
$ cd gpsd
$ scons timeservice=yes magic_hat=yes nmea0183=yes ublox=yes mtk3301=yes fixed_port_speed=9600 fixed_stop_bits=1</code></pre>
</div></div>
<div class="paragraph"><p>This builds gpsd in a minimal, fixed-speed timeserver mode.</p></div>
<div class="paragraph"><p>Now we use GPSD tools to verify that the GPS works.  Put your
SBC+HAT combination someplace, such as a windowsill, with a good sky
view outside.  The HATs described in this HOWTO have very good
weak-signal discrimination and are much less fussy about siting than
older GPS receivers; all should work quite well at or near a window.</p></div>
<div class="paragraph"><p>Here&#8217;s how to tell if your HAT has a fix.  The numbers are blink
intervals for the fix LED; "off" means the LED does not blink.</p></div>
<div class="tableblock">
<table rules="all"
width="50%"
frame="hsides"
cellspacing="0" cellpadding="4">
<caption class="title">Table 1. Blink interval in seconds</caption>
<col width="33%" />
<col width="33%" />
<col width="33%" />
<thead>
<tr>
<th align="left" valign="top"> HAT type                        </th>
<th align="left" valign="top"> No fix </th>
<th align="left" valign="top">  Fix</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p class="table">Adafruit GPS HAT</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
<td align="left" valign="top"><p class="table">10</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Uputronics GPS Expansion Board</p></td>
<td align="left" valign="top"><p class="table">off</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p>On first (cold) boot, the device may take 20-30 minutes to download a
satellite almanac.  After that, time to get a fix should be much faster
unless you live in a canyon (including the urban kind) or dense forest.
I, living in a suburb with the front of my house half-screened by tall
trees, typically get lock about 30 seconds from power up.  It will
seem longer than it is first time: have patience.</p></div>
<div class="paragraph"><p>Sudo to root, then run this:</p></div>
<div class="listingblock">
<div class="content">
<pre><code># cd /home/pi/gpsd
# ./gpsmon /dev/gpsd0</code></pre>
</div></div>
<div class="paragraph"><p>Running gpsmon should give you a nice panel display with a scrolling
window at the bottom showing the raw data and a top section showing
the analyzed fix and UTC time to the second.</p></div>
<div class="paragraph"><p>If you have a fix, you should also see bars denoting 1PPS once per
second between sentence bursts.  If you have a fix and <strong>don&#8217;t</strong> see
these, most likely you have forgotten to go root before running
gpsmon.</p></div>
<div class="paragraph"><p>Next, check that gpsd is shipping time notifications via the
shared-memory interface required by ntpd.  If you run ntpshmmon, you
should see time sample lines until you interrupt, looking something
like this:</p></div>
<div class="listingblock">
<div class="content">
<pre><code># ./gpsd /dev/gpsd0
# ./ntpshmmon
ntpshmmon version 1
#      Name   Seen@                Clock                Real               L Prec
sample NTP0 1462725362.567068197 1462725362.475583880 1462725362.000000000 0  -1
sample NTP1 1462725362.909592179 1462725362.908928852 1462725363.000000000 0 -20
sample NTP0 1462725363.067835766 1462725362.475583880 1462725362.000000000 0  -1
sample NTP1 1462725363.410437248 1462725362.908928852 1462725363.000000000 0 -20
sample NTP0 1462725363.568646773 1462725363.440431209 1462725363.000000000 0  -1
sample NTP1 1462725363.911264556 1462725363.908928951 1462725364.000000000 0 -20</code></pre>
</div></div>
<div class="paragraph"><p>If this fails or hangs, check to make sure that you configured gpsd in
time-service mode and your GPS has a fix.  If you see only "NTP2"
lines, you forgot to go root before starting gpsd.</p></div>
<div class="paragraph"><p>Having run this step, you now know that both data and 1PPS from the
HAT are fully visible on your SBC and gpsd collects them and provides
them over its shared-memory interface.  You can now proceed with
specializing your SBC to be a time server.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_build_and_configure_ntpsec">Build and configure NTPsec</h2>
<div class="sectionbody">
<div class="paragraph"><p>The stock ntpd shipped with your distribution is intended to be used as a
client instance, not a server.  It doesn&#8217;t do 1PPS, and therefore
can&#8217;t be used for precision timekeeping.  Thus, we&#8217;re going to build a
better version from source.  That version is NTPsec, which runs
lighter and more securely and can do more accurate time stepping.</p></div>
<div class="paragraph"><p>Install the build prerequisites {--config}:</p></div>
<div class="listingblock">
<div class="content">
<pre><code># apt install bison libcap-dev libssl-dev libreadline-dev</code></pre>
</div></div>
<div class="paragraph"><p>Build NTPsec {--build}.  The --refclock option says to include only
shared-memory refclock support, excluding all other drivers
<span class="footnote"><br />[As a convenience for NTPsec&#8217;s developers, the clockmaker
script installs a slightly larger set of clock drivers]<br /></span>.</p></div>
<div class="paragraph"><p>Exit root, and run this:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ cd /home/pi
$ git clone https://gitlab.com/NTPsec/ntpsec.git
$ cd ntpsec
$ ./waf configure --refclock=shm
$ ./waf build</code></pre>
</div></div>
<div class="paragraph"><p>Create your own NTP configuration with these contents as ntp.conf, but
don&#8217;t copy it to /etc yet {--build}.  We&#8217;re going to test this
configuration in place before installing it.</p></div>
<div class="listingblock">
<div class="content">
<pre><code># /etc/ntp.conf, configuration for ntpd; see ntp.conf(5) for help

# Prefer the precise clock at unit 1 over the imprecise one at unit 0.

# GPS PPS reference (NTP1)
refclock shm unit 1 refid PPS

# GPS Serial data reference (NTP0)
refclock shm unit 0 refid GPS

# Check servers
# If you have no other local chimers to help NTP perform sanity checks
# then you can use some public chimers from the NTP public pool:
# http://www.pool.ntp.org/en/
#
# iburst tells it to send the first few requests at 2 second intervals rather
# than wait for the poll interval which defaults to 64 seconds.  That greatly
# speeds up the time for ntpd to set the system time and start responding to
# requests.
#
# Notice we use the 'us' country code servers, otherwise we might get
# pool servers from opposite sides of the planet accuracy would likely
# be poor.  If you are not in the USA, then it will probably work to
# change the 'us' to your two letter country code.
#
# Major Internet-using countries with pools include:
# us gb de fr ru au at ca cn jp de fi it be br cz hk
#
# If you don't know your country code, find it at
#
# https://en.wikipedia.org/wiki/ISO_3166-1
#
# and then try pinging prepending it to ".pool.ntp.org" and pinging that.
# hostname. If you get a response, you can use it.
#
pool us.pool.ntp.org iburst

# By default, exchange time with everybody, but don't allow configuration.
restrict default kod limited nomodify nopeer noquery
restrict -6 default kod limited nomodify nopeer noquery

# Local users may interrogate the NTP server more closely.
restrict 127.0.0.1
restrict -6 ::1

# Drift file etc.
# Ensure that the directory exists, and is writable by whichever user
# the ntpd daemon runs as.
driftfile /var/lib/ntp/ntp.drift

# end</code></pre>
</div></div>
<div class="paragraph"><p>Here&#8217;s what the parts mean:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
GPS Serial data reference (NTP0)
</dt>
<dd>
<p>
   The line beginning "refclock shm unit 0" tells it we&#8217;re expecting fixes
   via the shared-memory mailbox, unit 0.  These will be labeled GPS
   because they are the GPS&#8217;s in-band time reports.
</p>
</dd>
<dt class="hdlist1">
GPS Serial data reference (NTP1)
</dt>
<dd>
<p>
   The line beginning "refclock shm unit 1" tells it we&#8217;re expecting fixes
   via the shared-memory mailbox, unit 1.  These will be labeled PPS
   because they come from the GPS&#8217;s 1PPS.
</p>
</dd>
<dt class="hdlist1">
Internet time servers
</dt>
<dd>
<p>
   This section specifies some NTP servers to act as a sanity
   check for our GPS time.
</p>
</dd>
</dl></div>
<div class="sect2">
<h3 id="_smoke_test_ntpsec">Smoke-test NTPsec</h3>
<div class="paragraph"><p>Sudo to root and turn off the default Rasbian timesyncd service:</p></div>
<div class="listingblock">
<div class="content">
<pre><code># systemctl stop systemd-timesyncd.service
# systemctl disable systemd-timesyncd.service</code></pre>
</div></div>
<div class="paragraph"><p>Note: As of the 2018-06-27 Raspian image, a bug may cause the following
error output when you try to stop timesyncd -</p></div>
<div class="listingblock">
<div class="content">
<pre><code>Warning: systemd-timesyncd.service changed on disk. Run 'systemctl daemon-reload' to reload units.</code></pre>
</div></div>
<div class="paragraph"><p>If so, just do as the warning states - type systemctl daemon-reload, then
run the systemctl <em>stop</em> and  <em>disable</em> again.</p></div>
<div class="paragraph"><p>Because Raspbian no longer includes ntpd, we need to add a user for ntpd
to run as, and create a couple of directories ntpd needs in place before
running.</p></div>
<div class="listingblock">
<div class="content">
<pre><code># adduser --system --no-create-home --disabled-login --gecos '' ntp
# addgroup --system ntp; addgroup ntp ntp
# mkdir -p /var/lib/ntp /var/log/ntpstats
# chown -R ntp:ntp /var/lib/ntp /var/log/ntpstats</code></pre>
</div></div>
<div class="paragraph"><p>Run gpsd, telling it to look at the GPS device. Since gpsd may still be
running from the Live test above which was done as user pi, we issue a
"pkill" just for good measure.</p></div>
<div class="listingblock">
<div class="content">
<pre><code># pkill gpsd
# cd /home/pi
# ./gpsd/gpsd /dev/gpsd0</code></pre>
</div></div>
<div class="paragraph"><p>Run your newly built ntpd, telling it to step time if required:</p></div>
<div class="listingblock">
<div class="content">
<pre><code># ./ntpsec/build/main/ntpd/ntpd -g -c ntpsec/ntp.conf</code></pre>
</div></div>
<div class="paragraph"><p>Run ntpq -p, and look for ntpd to begin using your PPS as its reference.
Be patient, it can sometimes take a few minutes to complete. Simply run
it repeatedly to watch it update.</p></div>
<div class="listingblock">
<div class="content">
<pre><code># ntpsec/build/main/ntpclients/ntpq -p
     remote           refid      st t when poll reach   delay   offset  jitter
==============================================================================
-SHM(0)          .GPS.            0 l   15   64    1    0.000  -515.07   0.002
*SHM(1)          .PPS.            0 l   14   64    1    0.000   -0.656   0.002
+tock.usshc.com  .GPS.            1 u   10   64    3   37.408    0.200   1.767
+clock.isc.org   .GPS.            1 u    7   64    3   74.901   -2.051   1.255
-tick.apple.com  .GPS.            1 u    6   64    3  479.285  204.508 109.733</code></pre>
</div></div>
<div class="paragraph"><p>You&#8217;re hoping for a display similar to the above, with two local devices and
three check sources.  A nonzero "reach" column on a source line indicates that
your ntp is getting time notifications from that source. You want your SHM(1)
to have an asterisk next to it, meaning that it is the current timesource of
your server.</p></div>
<div class="paragraph"><p>If the value under "reach" for the SHM lines remains zero, check again that
gpsd is running and ntpshmmon reports fix lines. Run through the live test
steps again if necessary.</p></div>
</div>
<div class="sect2">
<h3 id="_installation_and_boot_time_setup">Installation and boot-time setup</h3>
<div class="paragraph"><p>This step can be automated with "./clockmaker --install" done as root.</p></div>
<div class="paragraph"><p>Change to the directory your gpsd and ntpsec repository clones live in
and install both suites:</p></div>
<div class="listingblock">
<div class="content">
<pre><code># cd gpsd; scons install
# cd ../ntpsec; ./waf install; cp ntp.conf /etc</code></pre>
</div></div>
<div class="paragraph"><p>Install the <a href="pinup">pinup</a> script:</p></div>
<div class="listingblock">
<div class="content">
<pre><code># cp pinup /usr/local/bin</code></pre>
</div></div>
<div class="paragraph"><p>Copy the following block of text into the file <em>timeservice</em>; copy it to
/etc/init.d/timeservice and make it executable:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>#!/bin/sh

### BEGIN INIT INFO
# Provides:        timeserver
# Required-Start:  $network $remote_fs $syslog
# Required-Stop:   $network $remote_fs $syslog
# Default-Start:   2 3 4 5
# Default-Stop:    1
# Short-Description: Start time service
### END INIT INFO

PATH=/sbin:/bin:/usr/sbin:/usr/bin/:/usr/local/bin

. /lib/lsb/init-functions

DAEMON1=/usr/local/sbin/gpsd
PIDFILE1=/var/run/gpsd.pid
DAEMON2=/usr/local/sbin/ntpd
PIDFILE2=/var/run/ntpd.pid

test -x $DAEMON1 || exit 5
test -x $DAEMON2 || exit 5

LOCKFILE=/var/lock/ntpdate

lock_ntpdate() {
        if [ -x /usr/bin/lockfile-create ]; then
                lockfile-create $LOCKFILE
                lockfile-touch $LOCKFILE &amp;
                LOCKTOUCHPID="$!"
        fi
}

unlock_ntpdate() {
        if [ -x /usr/bin/lockfile-create ] ; then
                kill $LOCKTOUCHPID
                lockfile-remove $LOCKFILE
        fi
}

NTPD_OPTS=-g

RUNASUSER=ntp
UGID=$(getent passwd $RUNASUSER | cut -f 3,4 -d:) || true
if test "$(uname -s)" = "Linux"; then
        NTPD_OPTS="$NTPD_OPTS -u $UGID"
fi

# It's best to have gpsd start first.  That way when ntpd restarts it has
# a good local time handy.  If ntpd starts first, it will set the local
# clock using a remote, probably pool, server.  Then ntpd has to spend a
# whole day undoing the damage done to the PLL.

case $1 in
        start)
                # Make sure the UART device is in a good state
                # Adafruit HAT starts at some weird baud rate unknown to man.
                stty -F /dev/gpsd0 raw 9600 cs8 clocal -cstopb
                # Launch gpsd
                log_daemon_msg "Starting GPSD server" "timeservice"
                start-stop-daemon --start --quiet --oknodo --pidfile $PIDFILE1 --startas $DAEMON1 -- -P $PIDFILE1 $GPSD_OPTS /dev/gpsd0
                status=$?
                log_end_msg $status
                lock_ntpdate
                # Launch ntpd
                log_daemon_msg "Starting NTP server" "timeservice"
                start-stop-daemon --start --quiet --oknodo --pidfile $PIDFILE2 --startas $DAEMON2 -- -p $PIDFILE2 $NTPD_OPTS
                status=$?
                log_end_msg $status
                unlock_ntpdate
                ;;
        stop)
                log_daemon_msg "Stopping gpsd" "timeservice"
                start-stop-daemon --stop --quiet --oknodo --pidfile $PIDFILE1
                log_end_msg $?
                log_daemon_msg "Stopping ntpd" "timeservice"
                start-stop-daemon --stop --quiet --oknodo --pidfile $PIDFILE2
                log_end_msg $?
                rm -f $PIDFILE1 $PIDFILE2
                ;;
        restart|force-reload)
                $0 stop &amp;&amp; sleep 2 &amp;&amp; $0 start
                ;;
        try-restart)
                if $0 status &gt;/dev/null; then
                        $0 restart
                else
                        exit 0
                fi
                ;;
        reload)
                exit 3
                ;;
        status)
                status_of_proc $DAEMON1 "time service"
                status_of_proc $DAEMON2 "time service"
                ;;
        *)
                echo "Usage: $0 {start|stop|restart|try-restart|force-reload|status}"
                exit 2
                ;;
esac

# end</code></pre>
</div></div>
<div class="paragraph"><p>The commands to do this are:</p></div>
<div class="listingblock">
<div class="content">
<pre><code># cp timeservice /etc/init.d; chmod a+x /etc/init.d/timeservice</code></pre>
</div></div>
<div class="paragraph"><p>Copy the following block of text to the file <em>timeservice.service</em>, then
install it in the directory /etc/systemd/system/:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>[Unit]
Description=Manage time service daemons

[Service]
Type=oneshot
ExecStart=/etc/init.d/timeservice start
ExecStop=/etc/init.d/timeservice stop
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target</code></pre>
</div></div>
<div class="paragraph"><p>The command to do this is:</p></div>
<div class="listingblock">
<div class="content">
<pre><code># cp timeservice.service /etc/systemd/system/</code></pre>
</div></div>
<div class="paragraph"><p>Enable startup at boot with:</p></div>
<div class="listingblock">
<div class="content">
<pre><code># systemctl enable timeservice</code></pre>
</div></div>
<div class="paragraph"><p>What&#8217;s going on here: the file /etc/init.d/timeservice is a System V init
script conforming to LSB conventions.  If you decide to ditch systemd
you can make a link to it from, e.g. /etc/rc3.d and the right thing
will happen.  The file /etc/systemd/system/timeservice.service is
a systemd unit file that will call the System V init script to do the
real work.</p></div>
<div class="paragraph"><p>Reboot.  Check that gpsd and ntpd are running, and watch ntpq -p to
verify that you can see time samples coming in.</p></div>
</div>
<div class="sect2">
<h3 id="_secure_the_machine">Secure the machine</h3>
<div class="paragraph"><p>Final parts of this step can be automated with "./clockmaker --mask"
and "clockmaker --secure", both done as root.</p></div>
<div class="paragraph"><p>The fact that your SBC has a known default name and default user means
that it is very vulnerable to being attacked and exploited by anyone
who gets access to your network.  Here&#8217;s how to fix this:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
{--mask} On the SBC, create an account for "me" (whatever username you like)
  using <em>adduser</em> run as root.
</p>
</li>
<li>
<p>
{--mask} On the SBC, add yourself to the <em>sudo</em> and <em>dialout</em> groups.
  The first is necessary; the second is optional but will make some
  later test steps easier.  Replace <em>me</em> with the username you desire.
</p>
<div class="listingblock">
<div class="content">
<pre><code># usermod -a -G sudo,dialout me</code></pre>
</div></div>
</li>
<li>
<p>
{--mask} Optional step: In /etc/sudoers.d, create a file that
  will give you permission to sudo without a password.  It should
  look like this
</p>
<div class="listingblock">
<div class="content">
<pre><code>me ALL=(ALL) NOPASSWD: ALL</code></pre>
</div></div>
<div class="paragraph"><p>but with <em>me</em> replaced by your userid.  The name of the file doesn&#8217;t
matter, but must not end with a <em>~</em> or contain a <em>.</em>.</p></div>
</li>
<li>
<p>
{--mask} Move the contents of the default-user home directory to
  the home directory of the "me" account. Be sure to <em>chown</em> the files
  from the pi user to the new user.
</p>
</li>
<li>
<p>
From the host, verify that you can log in via ssh under your own
  name and sudo to a root shell with "sudo bash"; you should see a "#"
  prompt. Type <em>exit</em>, <em>logout</em>, or simply hit control-d to leave root.
</p>
</li>
<li>
<p>
From the host, export an ssh key from the "me" account to the
  SBC.  If you don&#8217;t understand this instruction, search for "ssh
  tutorial on the web and learn.  The
  <a href="http://www.catb.org/~esr/sshexport/">sshexport</a> tool may be useful.
</p>
</li>
<li>
<p>
Reboot the SBC.  Verify that you can login via ssh from your host
  machine to the "me" account on the SBC without giving a password.
  Then go root.
</p>
</li>
<li>
<p>
{--secure} On the SBC, disable root login and password tunneling.  To
  do this, edit its /etc/ssh/sshd_config file.  Change the
  "PermitRootLogin" and "PasswordAuthentication" lines so the second
  token is "no".
</p>
</li>
<li>
<p>
{--secure} On the SBC, disable the default-user login (on the RPi
  "deluser pi" as root).
</p>
</li>
</ol></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_final_configuration">Final configuration</h2>
<div class="sectionbody">
<div class="paragraph"><p>Now, before you change the hostname, would be a good time to use
"ddimage -b" to back up your customized Raspbian image.  Having done
that, you can later use ddimage to set up more servers without having to
go through the entire configuration process.</p></div>
<div class="paragraph"><p>Change your hostname to something entertaining by editing
/etc/hostname.  Note, this should just be a local name without a
domain part.</p></div>
<div class="paragraph"><p>If you skipped to this step after making your SD image from a
backup, don&#8217;t forget to run "pinup -p" to set the GPIO pin
for your daughterboard type.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_performance_tuning">Performance tuning</h2>
<div class="sectionbody">
<div class="paragraph"><p>Don&#8217;t be overly concerned if ntpq -p initially shows large jitter.
This probably just means your clock was off by a few seconds - not
uncommon on SBCs without a battery-backed real-time clock.  Initially,
ntpd has no way to separate actual jitter from the clock offset.
This will probably fix itself in a few hours of operation once ntpd
has pulled your system clock close to the PPS time.</p></div>
<div class="paragraph"><p>For more about performance tuning and how to fudge your configuration,
see
<a href="https://gpsd.gitlab.io/gpsd/gpsd-time-service-howto.html#_performance_tuning">https://gpsd.gitlab.io/gpsd/gpsd-time-service-howto.html#_performance_tuning</a>
[the GPSD Time Service HOWTO&#8217;s section on tuning].</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_simplification_and_optimization">Simplification and optimization</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_thin_out_the_system_processes">Thin out the system processes</h3>
<div class="paragraph"><p>The Raspbian default is to install a lot of background processes that
exist to support a graphical desktop.  Installing from the Lite image
eliminates most of these.  This reduces load variability on the
processor, which will decrease your time jitter.  It will also cut
your power draw and heat dissipation, increasing the Pi&#8217;s expected
lifetime.  Most importantly, it will reduce the number of ways for
things to go wrong.</p></div>
<div class="paragraph"><p>You can strip down a bit further with these commands:</p></div>
<div class="listingblock">
<div class="content">
<pre><code># apt -y purge bluez triggerhappy
# apt -y autoremove</code></pre>
</div></div>
<div class="paragraph"><p>This step can be done conveniently with "clockmaker --strip" run as root.</p></div>
<div class="paragraph"><p>The resulting configuration is pretty minimal, as you can verify by
running "pstree -paul" (or the older-school "ps ax") and noticing that
most of the background processes are kernel threads.</p></div>
<div class="paragraph"><p>Note that triggerhappy is required for raspi-config; after you remove
it, <em>apt autoremove</em> will remove raspi-config.  This is easily
reversed by reinstalling raspi-config.</p></div>
<div class="paragraph"><p>WiFi is deliberately not removed, in order to give
you a fallback TCP/IP access when a cable is inconvenient.
If you want to banish WiFi, this will do:</p></div>
<div class="listingblock">
<div class="content">
<pre><code># apt -y remove wpasupplicant</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_configuring_for_a_static_ip_address">Configuring for a static IP address</h3>
<div class="paragraph"><p>If you&#8217;re only going to use the SBC as a time service for your local
network, you can cite its zeroconf (.local) address in other ntp.conf
files.  If you want to expose it as a public server you&#8217;ll need to
configure the SBC to use a fixed, static IP address.  That process is
described in <a href="#EAT-STATIC">[EAT-STATIC]</a>.</p></div>
<div class="paragraph"><p>If you do this, and verify that it works, you can remove avahi-daemon
and dhcpd5, further cutting the number of service processes running.</p></div>
<div class="listingblock">
<div class="content">
<pre><code># apt -y purge avahi-daemon dhcpcd5</code></pre>
</div></div>
<div class="paragraph"><p>Once you do this, the SBC will no longer be accessible at a ".local"
address.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_using_pinup">Using pinup</h2>
<div class="sectionbody">
<div class="paragraph"><p>We provide a script called <a href="pinup">pinup</a> that makes it easy to
query the configuration of your timeserver, and change its 1PPS
GPIO pin when required.</p></div>
<div class="paragraph"><p>Call "pinup" without arguments to query the configuration:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ ./pinup
Raspberry Pi 3 Model B, configured for the Adafruit HAT.</code></pre>
</div></div>
<div class="paragraph"><p>Calling "pinup -p" as root allows you to choose a GPIO pin for 1PPS
from a menu of daughterboard types.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_technical_notes_for_advanced_users">Technical notes for advanced users</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_the_update_mode">The --update mode</h3>
<div class="paragraph"><p>After first configuring and building your server software, you can use
the --update mode of clockmaker to update your software without
re-generating ntp.conf (this replaces --build).  This may be useful if
you have put local customizations in ntp.conf.</p></div>
</div>
<div class="sect2">
<h3 id="_why_gpsd">Why GPSD?</h3>
<div class="paragraph"><p>If you are already familiar with ntpd and wonder why this recipe uses
gpsd through SHM rather than ntpd&#8217;s native refclock 20 GPS driver, the
answer is this: when refclock 20 is configured to use 1PPS, it mixes
in-band time data with 1PPS in a way that causes it to behave badly,
and possibly get rejected as a falseticker, when 1PPS is only
occasionally available.</p></div>
</div>
<div class="sect2">
<h3 id="_edge_detection_issues_and_new_hats">Edge-detection issues and new HATs</h3>
<div class="paragraph"><p>The pps-gpio module as of April 2016 has a flaw.  It catches only
one edge of the PPS.  You have a 50/50 chance you are seeing the
falling edge rather than the assert edge (which is the actual top of
second).  A patch to fix this has been submitted to the Linux kernel
maintainers but not merged.</p></div>
<div class="paragraph"><p>Which edge the kernel will see, and the pulse width, are constant
depending on the GPS type and firmware (and if you can find a real
datasheet for the GPS engine it will tell you the pulse width).  If the
kernel sees the falling edge, the width of the pulse emitted by your
GPS will introduce a fixed lag from top of second to the time when you
actually see the PPS.</p></div>
<div class="paragraph"><p>Pulse widths (and the induced lag) range from so fast the serial
driver can&#8217;t see them to, worst case, 0.5s.  The worst case is rare;
typical pulse widths are 50 to 200ms.  Because the error is constant,
you can compensate it out with an offset if you know what it is.
HATs marked "assert edge" below do not require compensation.</p></div>
<div class="tableblock">
<table rules="all"
width="25%"
frame="hsides"
cellspacing="0" cellpadding="4">
<col width="25%" />
<col width="25%" />
<col width="25%" />
<col width="25%" />
<thead>
<tr>
<th align="left" valign="top">Type           </th>
<th align="left" valign="top"> Chipset    </th>
<th align="left" valign="top"> 1PPS width  </th>
<th align="left" valign="top"> pps-gpio detects</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p class="table">Adafruit HAT</p></td>
<td align="left" valign="top"><p class="table">MTK3339</p></td>
<td align="left" valign="top"><p class="table">100ms</p></td>
<td align="left" valign="top"><p class="table">assert edge</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Uputronics HAT</p></td>
<td align="left" valign="top"><p class="table">Ublox 8</p></td>
<td align="left" valign="top"><p class="table">100ms</p></td>
<td align="left" valign="top"><p class="table">assert edge</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p>These details will become relevant whenever we qualify a new HAT
for coverage in this HOWTO.  The important thing to check is whether
the pps-gpio driver triggers on assert or falling edge.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_adequate_power_is_important">Adequate power is important</h2>
<div class="sectionbody">
<div class="paragraph"><p>Hackerboards like the Pi and BeagleBone are picky about
getting clean power at the full specified level because they&#8217;re
designed for lowest cost.  Power regulation is expensive compared to
logic gates, and this is one of the corners they cut.  Under-voltage
or under-wattage can cause failures to boot, lockups, or mystery
crashes.</p></div>
<div class="paragraph"><p>You&#8217;re generally safe if you use a vendor&#8217;s wall wart matched to the
device.  But there are a lot of crappy power supplies that don’t come
close to putting out the volts/amps/watts that they are rated for.
The power supplies, too, are made with extreme cost cutting measures -
and worse, false marketing/advertising.</p></div>
<div class="paragraph"><p>It&#8217;s best to buy a power supply from a board reseller that the
reseller “qualifies” or recommends for the board.  Even then you
may run into problems, because the board builders might underestimate
current draw with peripherals attached.  The RasPi foundation was
selling and recommending 2A power supplies for a while before they
figured out that the actual draw with all ports active was close to 2.5A</p></div>
<div class="paragraph"><p>Problems may arise if you try powering from a USB hub that isn&#8217;t quite
up to snuff, or have lossy USB cables.  I&#8217;ve had good results with a
powered hub from Anker, the class act in USB equipment, and I&#8217;m told
Tronsmart is also a pretty reliable brand.  Beware of going cheap here.</p></div>
<div class="paragraph"><p>Unless your USB cable is really short (1 foot, or less) you also need
20AWG USB cables (the nominal standard gauge for USB), not the 28AWG
or smaller "thin" USB cables often shipped to cut prices.  28AWG is
0.064 ohms per foot.  Double that for out and back to 0.128 ohms/ft of
USB cable.</p></div>
<div class="paragraph"><p>Anecdotal evidence says you can run a Pi 3 on 4.8V but less is a
problem.  Running headless (without a mouse, keyboard or display) and
without a HAT, a Pi 3 will draw about 700mA, but peripherals rapidly
drive up power consumption to where even 2A isn&#8217;t enough; the Pi
Foundation recommends 2.5A.</p></div>
<div class="paragraph"><p>On a Raspberry Pi B+, 2 &amp; 3, the red Power LED will turn off to
indicate if voltage drops below 4.63V.  If it&#8217;s not staying on solid,
the power supply or power cable is not adequate.  Also, I&#8217;m told that
before the power LED flickers, or goes out, there will be a rainbow
colored box on the top left of the HDMI output screen.</p></div>
<div class="paragraph"><p>There are a lot of really bad USB cables on the market, and it is wise
to avoid the price basement here too.  I&#8217;ve had good results with
bulk-pack 3-foot cables from Monoprice.  When in doubt, apply a USB V/A
meter; Newegg has them for less than $10.  Be sure your meter can do 9V
for the new Quick Charge standard.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_future_direction">Future Direction</h2>
<div class="sectionbody">
<div class="paragraph"><p>Future versions of this HOWTO will broaden the hardware base to
include some BeagleBone variant.</p></div>
<div class="paragraph"><p>We tried making this recipe work with the Odroid C2 but found it too
unstable to hand to newbies.  We may try again when it has matured.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_references">References</h2>
<div class="sectionbody">
<div class="ulist bibliography"><ul>
<li>
<p>
<a id="GPSD-SERVICE"></a>[GPSD-SERVICE] <a href="https://gpsd.gitlab.io/gpsd/gpsd-time-service-howto.html">GPSD Time Service HOWTO</a>
</p>
</li>
<li>
<p>
<a id="STANDOFFS"></a>[STANDOFFS] <a href="https://www.adafruit.com/product/2336">Brass M2.5 Standoffs for Pi</a>
</p>
</li>
<li>
<p>
<a id="2258"></a>[2258] <a href="https://www.adafruit.com/product/2258">Adafruit Raspberry Pi B+ / Pi 2 / Pi 3 Case - Smoke Base - w/ Clear Top</a>
</p>
</li>
<li>
<p>
<a id="MODMYPI-CASE"></a>[MODMYPI-CASE] <a href="https://store.uputronics.com/index.php?route=product/product&amp;product_id=90">ModMyPi Pi GPS Case (Matte Black)</a> also available direct from ModMyPi in <a href="https://www.modmypi.com/raspberry-pi/cases/modmypi-single-colour/gps-case-black">Matte Black</a> or <a href="https://www.modmypi.com/raspberry-pi/cases/modmypi-single-colour/gps-case">Clear</a>
</p>
</li>
<li>
<p>
<a id="PI-PINOUT"></a>[PI-PINOUT] <a href="https://pinout.xyz">Raspberry Pi 3 Model B GPIO 40 Pin Block Pinout</a>
</p>
</li>
<li>
<p>
<a id="UART-ISSUE"></a>[UART-ISSUE] <a href="https://www.raspberrypi.org/forums/viewtopic.php?uid=191178&amp;f=28&amp;t=148218&amp;start=0">UART Issue</a>
</p>
</li>
<li>
<p>
<a id="RASPBIAN"></a>[RASPBIAN] <a href="https://www.raspberrypi.org/downloads/raspbian/">Raspbian downloads</a>
</p>
</li>
<li>
<p>
<a id="INSTALLATION"></a>[INSTALLATION]
  <a href="https://www.raspberrypi.org/documentation/installation/installing-images/linux.md">Installing Operating System Images Under Linux</a>
</p>
</li>
<li>
<p>
<a id="NTPSEC"></a>[NTPSEC] <a href="https://www.ntpsec.org/">The NTPsec project</a>
</p>
</li>
<li>
<p>
<a id="DOREY"></a>[DOREY] <a href="http://www.briandorey.com/post/Raspberry-Pi-3-UART-Overlay-Workaround">Raspberry Pi 3 UART Overlay Workaround</a>
</p>
</li>
<li>
<p>
<a id="ADAFRUIT-SETUP"></a>[ADAFRUIT-SETUP] <a href="https://learn.adafruit.com/adafruit-ultimate-gps-hat-for-raspberry-pi/pi-setup">Pi GPS Setup</a>
</p>
</li>
<li>
<p>
<a id="ADAFRUIT-TEST"></a>[ADAFRUIT-TEST] <a href="https://learn.adafruit.com/adafruit-ultimate-gps-hat-for-raspberry-pi/basic-test">Basic Test</a>
</p>
</li>
<li>
<p>
<a id="TAYLOR"></a>[TAYLOR] <a href="http://www.satsignal.eu/ntp/Raspberry-Pi-quickstart.html">RPi quick start</a>
</p>
</li>
<li>
<p>
<a id="EAT-STATIC"></a>[EAT-STATIC] <a href="http://www.modmypi.com/blog/tutorial-how-to-give-your-raspberry-pi-a-static-ip-address">Tutorial - How to give your Raspberry Pi a Static IP Address</a>
</p>
</li>
<li>
<p>
<a id="ODROID"></a>[ODROID] <a href="http://forum.odroid.com/viewtopic.php?f=111&amp;t=7660">GPS
  unit for odroid c1</a>
</p>
</li>
<li>
<p>
<a id="TICKLESS"></a>[TICKLESS] <a href="https://www.kernel.org/doc/Documentation/timers/NO_HZ.txt">https://www.kernel.org/doc/Documentation/timers/NO_HZ.txt</a>
</p>
</li>
</ul></div>
<div class="ulist"><ul>
<li>
<p>
<a id="GPIO"></a>[GPIO] <a href="http://spellfoundry.com/2016/05/29/configuring-gpio-serial-port-raspbian-jessie-including-pi-3/">Configuring The GPIO Serial Port On Raspbian Jessie Including Pi 3</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect1">
<h2 id="_revision_history">Revision history:</h2>
<div class="sectionbody">
<div class="dlist"><dl>
<dt class="hdlist1">
1.0: 2016-12-01
</dt>
<dd>
<p>
     First official release.
</p>
</dd>
<dt class="hdlist1">
1.1: 2016-12-11
</dt>
<dd>
<p>
     Use pool keyword in configuration.  /dev/gpsd0 &#8594; /dev/gps0.
</p>
</dd>
<dt class="hdlist1">
1.2: 2016-12-21
</dt>
<dd>
<p>
     /dev/gps0 back to /dev/gpsd0; previous change hurt GPSD compatibility
</p>
</dd>
<dt class="hdlist1">
1.3: 2017-01-02
</dt>
<dd>
<p>
     Track an incompatible change in GPSD configuration.
</p>
</dd>
<dt class="hdlist1">
1.4: 2017-10-03
</dt>
<dd>
<p>
     Update for Debian Stretch version of Raspbian.  We no longer need
     an entire raspi-config phase.
</p>
</dd>
<dt class="hdlist1">
1.5: 2018-07-31
</dt>
<dd>
<p>
     Add recognition code for RasPi version 3B+.
</p>
</dd>
</dl></div>
</div>
</div>
<div class="sect1">
<h2 id="_acknowledgements">Acknowledgements</h2>
<div class="sectionbody">
<div class="paragraph"><p>Various devteam members and friends of the GPSD and NTPsec projects
assisted with this HOWTO, including: Gary E. Miller, Hal Murray,
Phil Salkie, and Richard Laager. Paul Theodoropoulos contributed
to the 1.4 version.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_other_resources">Other resources</h2>
<div class="sectionbody">
<div class="paragraph"><p><a href="http://ava.upuaut.net/?p=726">Not quite 5 minute guide to making an NTP Server</a></p></div>
</div>
</div>
</div>
<div id="footnotes"><hr /></div>
<div id="footer">
<div id="footer-text">
Last updated
 2023-02-12 04:01:34 UTC
</div>
</div>
</body>
</html>
